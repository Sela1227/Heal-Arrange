{% extends "base.html" %}

{% block title %}èª¿åº¦å° - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š èª¿åº¦å°</h1>
        <p class="text-gray-500">{{ today }} | å…± {{ stats.total }} ä½ç—…äºº</p>
    </div>
    <div class="flex items-center space-x-4">
        <div class="text-sm">
            <span class="text-green-600">âœ… {{ stats.completed }}</span>
            <span class="text-gray-400 mx-1">|</span>
            <span class="text-blue-600">ğŸ”„ {{ stats.in_progress }}</span>
            <span class="text-gray-400 mx-1">|</span>
            <span class="text-gray-500">â³ {{ stats.not_started }}</span>
        </div>
    </div>
</div>

<!-- æ•…éšœè¨­å‚™è­¦ç¤º -->
<div id="broken-alert"
     hx-get="/dispatcher/api/broken-equipment"
     hx-trigger="every 5s"
     hx-swap="innerHTML">
    {% include "partials/broken_alert.html" %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦å´ï¼šç—…äººåˆ—è¡¨ -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                <span class="font-bold text-gray-700">ğŸ“‹ ä»Šæ—¥ç—…äºº</span>
                <span class="text-sm text-gray-500">æ¯ 5 ç§’è‡ªå‹•æ›´æ–°</span>
            </div>
            
            <div id="patient-table"
                 hx-get="/dispatcher/api/patients"
                 hx-trigger="every 5s"
                 hx-swap="innerHTML"
                 class="overflow-x-auto">
                {% include "partials/patient_table.html" %}
            </div>
        </div>
    </div>
    
    <!-- å³å´ï¼šæª¢æŸ¥ç«™ç‹€æ…‹ + è¨­å‚™å›å ± -->
    <div class="space-y-6">
        <!-- æª¢æŸ¥ç«™ç‹€æ…‹ -->
        <div class="bg-white rounded-xl shadow">
            <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
                ğŸ¥ æª¢æŸ¥ç«™ç‹€æ…‹
            </div>
            <div id="station-cards"
                 hx-get="/dispatcher/api/stations"
                 hx-trigger="every 5s"
                 hx-swap="innerHTML"
                 class="p-4">
                {% include "partials/station_cards.html" %}
            </div>
        </div>
        
        <!-- è¨­å‚™æ•…éšœå›å ± -->
        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="font-bold text-gray-700 mb-3">ğŸ”§ è¨­å‚™æ•…éšœå›å ±</h3>
            <form action="/dispatcher/report-equipment-failure" method="POST">
                <div class="space-y-3">
                    <select name="equipment_id" required
                            class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">é¸æ“‡è¨­å‚™</option>
                        {% for eq in all_equipment %}
                        <option value="{{ eq.id }}">
                            {{ eq.name }} ({{ eq.location }})
                            {% if eq.status == 'broken' %}âš ï¸{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="text" name="description" placeholder="æ•…éšœæè¿°ï¼ˆé¸å¡«ï¼‰"
                           class="w-full border rounded-lg px-3 py-2 text-sm">
                    <button type="submit"
                            class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm font-medium">
                        ğŸš¨ å›å ±æ•…éšœ
                    </button>
                </div>
            </form>
        </div>
        
        <!-- å°ˆå“¡/çµ„é•·ç‹€æ…‹ -->
        <div class="bg-white rounded-xl shadow">
            <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
                ğŸ‘¤ å°ˆå“¡/çµ„é•·ç‹€æ…‹
            </div>
            <div class="divide-y">
                {% for coord in coordinators %}
                <div class="px-4 py-3 flex justify-between items-center">
                    <span>{{ coord.display_name }}</span>
                    <span class="text-xs text-gray-400">
                        {% set has_patient = false %}
                        {% for info in patient_list %}
                            {% if info.coordinator and info.coordinator.id == coord.id %}
                                {% set has_patient = true %}
                                <span class="text-green-600">{{ info.patient.name }}</span>
                            {% endif %}
                        {% endfor %}
                        {% if not has_patient %}
                        <span class="text-gray-400">ç©ºé–’</span>
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
                
                {% if not coordinators %}
                <div class="px-4 py-6 text-center text-gray-400 text-sm">
                    å°šç„¡å°ˆå“¡
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
