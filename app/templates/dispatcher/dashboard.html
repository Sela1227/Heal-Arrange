{% extends "base.html" %}

{% block title %}èª¿åº¦å° - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-4 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š èª¿åº¦å°</h1>
        <p class="text-gray-500">{{ today.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</p>
    </div>
    <div class="flex items-center space-x-4">
        <!-- çµ±è¨ˆ -->
        <div class="flex space-x-2 text-sm">
            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">ç¸½è¨ˆ {{ stats.total }}</span>
            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">å®Œæˆ {{ stats.completed }}</span>
            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded">é€²è¡Œ {{ stats.in_progress }}</span>
            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded">æœªé–‹å§‹ {{ stats.not_started }}</span>
        </div>
    </div>
</div>

<!-- æ•…éšœè­¦ç¤ºï¼ˆHTMX å³æ™‚æ›´æ–°ï¼‰ -->
<div id="broken-alert"
     hx-get="/dispatcher/api/broken-equipment"
     hx-trigger="every 5s"
     hx-swap="innerHTML">
    {% include "partials/broken_alert.html" %}
</div>

<!-- è¨­å‚™æ•…éšœå›å ± -->
<div class="bg-white rounded-xl shadow p-4 mb-4">
    <form action="/dispatcher/report-equipment-failure" method="POST" class="flex items-center gap-4">
        <span class="text-gray-600">âš ï¸ è¨­å‚™æ•…éšœå›å ±ï¼š</span>
        <select name="equipment_id" required class="border rounded-lg px-3 py-2">
            <option value="">é¸æ“‡è¨­å‚™</option>
            {% for eq in all_equipment %}
            <option value="{{ eq.id }}">{{ eq.name }} ({{ eq.location }})</option>
            {% endfor %}
        </select>
        <input type="text" name="description" placeholder="æ•…éšœæè¿°ï¼ˆé¸å¡«ï¼‰" 
               class="border rounded-lg px-3 py-2 flex-1">
        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
            å›å ±æ•…éšœ
        </button>
    </form>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦å´ï¼šç—…äººåˆ—è¡¨ -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center">
                <span>ğŸ“‹ ä»Šæ—¥ç—…äººåˆ—è¡¨</span>
                <span class="text-sm font-normal text-gray-500">å…± {{ patient_list|length }} äºº</span>
            </div>
            
            <div id="patient-table"
                 class="overflow-x-auto max-h-[600px] overflow-y-auto"
                 hx-get="/dispatcher/api/patients"
                 hx-trigger="every 5s"
                 hx-swap="innerHTML">
                {% include "partials/patient_table.html" %}
            </div>
        </div>
    </div>
    
    <!-- å³å´ï¼šæª¢æŸ¥ç«™ç‹€æ…‹ -->
    <div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
                ğŸ¥ æª¢æŸ¥ç«™ç‹€æ…‹
            </div>
            
            <div id="station-cards"
                 class="p-4 space-y-3 max-h-[600px] overflow-y-auto"
                 hx-get="/dispatcher/api/stations"
                 hx-trigger="every 5s"
                 hx-swap="innerHTML">
                {% include "partials/station_cards.html" %}
            </div>
        </div>
        
        <!-- å°ˆå“¡ç‹€æ…‹ï¼ˆåŸå€‹ç®¡å¸«ç‹€æ…‹ï¼‰ -->
        <div class="bg-white rounded-xl shadow overflow-hidden mt-4">
            <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
                ğŸ‘¤ å°ˆå“¡ç‹€æ…‹
            </div>
            <div class="divide-y max-h-64 overflow-y-auto">
                {% for coord in coordinators %}
                <div class="px-4 py-2 flex items-center justify-between">
                    <div class="flex items-center">
                        {% if coord.picture_url %}
                        <img src="{{ coord.picture_url }}" alt="" class="w-8 h-8 rounded-full mr-2">
                        {% else %}
                        <div class="w-8 h-8 rounded-full bg-green-100 mr-2 flex items-center justify-center text-green-600">
                            ğŸ‘¤
                        </div>
                        {% endif %}
                        <span>{{ coord.display_name }}</span>
                    </div>
                    <span class="text-xs text-gray-400">
                        {% set has_patient = false %}
                        {% for info in patient_list %}
                            {% if info.coordinator and info.coordinator.id == coord.id %}
                                {% set has_patient = true %}
                            {% endif %}
                        {% endfor %}
                        {% if has_patient %}
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded">æœå‹™ä¸­</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-500 rounded">ç©ºé–’</span>
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
                
                {% if not coordinators %}
                <div class="px-4 py-8 text-center text-gray-400">
                    å°šç„¡å°ˆå“¡å¸³è™Ÿ
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// HTMX è«‹æ±‚æ™‚æ·»åŠ  loading æ•ˆæœ
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    evt.detail.elt.classList.add('loading');
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
    evt.detail.elt.classList.remove('loading');
});
</script>
{% endblock %}
