{% extends "base.html" %}

{% block title %}è¶¨å‹¢å ±è¡¨ - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“ˆ è¶¨å‹¢å ±è¡¨</h1>
    <div class="flex items-center space-x-2">
        <a href="/admin/reports/trend/pdf?days={{ days }}"
           class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
            ğŸ“„ åŒ¯å‡º PDF
        </a>
        <a href="/admin/reports" class="text-blue-500 hover:underline">â† è¿”å›å ±è¡¨</a>
    </div>
</div>

<!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
<div class="flex flex-wrap gap-2 mb-6">
    <a href="/admin/reports/trend?days=7"
       class="px-4 py-2 rounded-lg {% if days == 7 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        7 å¤©
    </a>
    <a href="/admin/reports/trend?days=14"
       class="px-4 py-2 rounded-lg {% if days == 14 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        14 å¤©
    </a>
    <a href="/admin/reports/trend?days=30"
       class="px-4 py-2 rounded-lg {% if days == 30 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        30 å¤©
    </a>
</div>

<div class="text-sm text-gray-500 mb-4">
    ğŸ“… {{ start_date }} ~ {{ end_date }}
</div>

<!-- Chart.js åœ–è¡¨å€åŸŸ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- ç—…äººæ•¸è¶¨å‹¢åœ– -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">æ¯æ—¥ç—…äººæ•¸</h3>
        <div style="height: 300px;">
            <canvas id="patientsChart"></canvas>
        </div>
    </div>
    
    <!-- å®Œæˆç‡è¶¨å‹¢åœ– -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">å®Œæˆç‡è¶¨å‹¢</h3>
        <div style="height: 300px;">
            <canvas id="completionChart"></canvas>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆæ‘˜è¦ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    {% set total_patients = daily_summaries|map(attribute='patients.total')|sum %}
    {% set total_completed = daily_summaries|map(attribute='patients.completed')|sum %}
    {% set avg_patients = (total_patients / days)|round(1) %}
    {% set avg_completion = (total_completed / total_patients * 100)|round(1) if total_patients > 0 else 0 %}
    
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-blue-600">{{ total_patients }}</div>
        <div class="text-sm text-gray-500">ç¸½ç—…äººæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-green-600">{{ total_completed }}</div>
        <div class="text-sm text-gray-500">ç¸½å®Œæˆæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-purple-600">{{ avg_patients }}</div>
        <div class="text-sm text-gray-500">æ—¥å‡ç—…äºº</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold {% if avg_completion >= 80 %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ avg_completion }}%
        </div>
        <div class="text-sm text-gray-500">å¹³å‡å®Œæˆç‡</div>
    </div>
</div>

<!-- æ¯æ—¥è©³ç´°åˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b">
        <span class="font-bold text-gray-700">æ¯æ—¥è©³ç´°æ•¸æ“š</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-center">ç¸½ç—…äºº</th>
                    <th class="px-4 py-3 text-center">å·²å®Œæˆ</th>
                    <th class="px-4 py-3 text-center">é€²è¡Œä¸­</th>
                    <th class="px-4 py-3 text-center">æœªé–‹å§‹</th>
                    <th class="px-4 py-3 text-center">å®Œæˆç‡</th>
                    <th class="px-4 py-3 text-center">è¨­å‚™æ•…éšœ</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                {% for summary in daily_summaries|reverse %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">
                        {{ summary.date.strftime('%Y-%m-%d') }}
                        {% if summary.date == today %}
                        <span class="text-xs text-green-500">(ä»Šæ—¥)</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">{{ summary.patients.total }}</td>
                    <td class="px-4 py-3 text-center text-green-600">{{ summary.patients.completed }}</td>
                    <td class="px-4 py-3 text-center text-yellow-600">{{ summary.patients.in_progress }}</td>
                    <td class="px-4 py-3 text-center text-gray-400">{{ summary.patients.not_started }}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs font-medium
                                    {% if summary.patients.completion_rate >= 80 %}bg-green-100 text-green-700
                                    {% elif summary.patients.completion_rate >= 50 %}bg-yellow-100 text-yellow-700
                                    {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ summary.patients.completion_rate }}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if summary.equipment.broken > 0 %}
                        <span class="text-red-500">{{ summary.equipment.broken }}</span>
                        {% else %}
                        <span class="text-green-500">0</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// æº–å‚™æ•¸æ“š
const labels = [{% for s in daily_summaries %}'{{ s.date.strftime("%m/%d") }}'{% if not loop.last %},{% endif %}{% endfor %}];
const totalData = [{% for s in daily_summaries %}{{ s.patients.total }}{% if not loop.last %},{% endif %}{% endfor %}];
const completedData = [{% for s in daily_summaries %}{{ s.patients.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
const completionRates = [{% for s in daily_summaries %}{{ s.patients.completion_rate }}{% if not loop.last %},{% endif %}{% endfor %}];

// ç—…äººæ•¸è¶¨å‹¢åœ–
const patientsCtx = document.getElementById('patientsChart').getContext('2d');
new Chart(patientsCtx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'ç¸½ç—…äººæ•¸',
                data: totalData,
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1,
                borderRadius: 4,
            },
            {
                label: 'å·²å®Œæˆ',
                data: completedData,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1,
                borderRadius: 4,
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// å®Œæˆç‡è¶¨å‹¢åœ–
const completionCtx = document.getElementById('completionChart').getContext('2d');
new Chart(completionCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'å®Œæˆç‡ (%)',
            data: completionRates,
            fill: true,
            backgroundColor: 'rgba(139, 92, 246, 0.2)',
            borderColor: 'rgba(139, 92, 246, 1)',
            borderWidth: 2,
            tension: 0.3,
            pointBackgroundColor: 'rgba(139, 92, 246, 1)',
            pointRadius: 4,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
