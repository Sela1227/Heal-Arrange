{% extends "base.html" %}

{% block title %}è¶¨å‹¢å ±è¡¨ - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“ˆ è¶¨å‹¢å ±è¡¨</h1>
    <a href="/admin/reports" class="text-blue-500 hover:underline">â† è¿”å›å ±è¡¨</a>
</div>

<!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
<div class="flex flex-wrap gap-2 mb-6">
    <a href="/admin/reports/trend?days=7"
       class="px-4 py-2 rounded-lg {% if days == 7 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        7 å¤©
    </a>
    <a href="/admin/reports/trend?days=14"
       class="px-4 py-2 rounded-lg {% if days == 14 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        14 å¤©
    </a>
    <a href="/admin/reports/trend?days=30"
       class="px-4 py-2 rounded-lg {% if days == 30 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        30 å¤©
    </a>
</div>

<div class="text-sm text-gray-500 mb-4">
    ğŸ“… {{ start_date }} ~ {{ end_date }}
</div>

<!-- è¶¨å‹¢åœ–è¡¨ï¼ˆç°¡æ˜“ç‰ˆ - ä½¿ç”¨ CSSï¼‰ -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h3 class="font-bold text-gray-700 mb-4">æ¯æ—¥ç—…äººæ•¸ & å®Œæˆç‡</h3>
    
    <!-- ç°¡æ˜“é•·æ¢åœ– -->
    <div class="space-y-3">
        {% for summary in daily_summaries %}
        <div class="flex items-center">
            <div class="w-20 text-sm text-gray-500">
                {{ summary.date.strftime('%m/%d') }}
            </div>
            <div class="flex-1 flex items-center space-x-2">
                <!-- ç—…äººæ•¸é•·æ¢ -->
                <div class="flex-1 bg-gray-100 rounded-full h-6 relative">
                    {% set max_patients = daily_summaries|map(attribute='patients.total')|max or 1 %}
                    {% set width = (summary.patients.total / max_patients * 100)|int %}
                    <div class="bg-blue-400 h-6 rounded-full flex items-center justify-end pr-2"
                         style="width: {{ width }}%">
                        {% if width > 15 %}
                        <span class="text-xs text-white font-medium">{{ summary.patients.total }}</span>
                        {% endif %}
                    </div>
                    {% if width <= 15 %}
                    <span class="absolute left-2 top-1 text-xs text-gray-600">{{ summary.patients.total }}</span>
                    {% endif %}
                </div>
                <!-- å®Œæˆç‡ -->
                <div class="w-16 text-right">
                    <span class="text-sm {% if summary.patients.completion_rate >= 80 %}text-green-600{% elif summary.patients.completion_rate >= 50 %}text-yellow-600{% else %}text-red-600{% endif %} font-medium">
                        {{ summary.patients.completion_rate }}%
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="flex justify-end mt-4 text-xs text-gray-400">
        <span class="mr-4">ğŸ”µ ç—…äººæ•¸</span>
        <span>% å®Œæˆç‡</span>
    </div>
</div>

<!-- çµ±è¨ˆæ‘˜è¦ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    {% set total_patients = daily_summaries|map(attribute='patients.total')|sum %}
    {% set total_completed = daily_summaries|map(attribute='patients.completed')|sum %}
    {% set avg_patients = (total_patients / days)|round(1) %}
    {% set avg_completion = (total_completed / total_patients * 100)|round(1) if total_patients > 0 else 0 %}
    
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-blue-600">{{ total_patients }}</div>
        <div class="text-sm text-gray-500">ç¸½ç—…äººæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-green-600">{{ total_completed }}</div>
        <div class="text-sm text-gray-500">ç¸½å®Œæˆæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-purple-600">{{ avg_patients }}</div>
        <div class="text-sm text-gray-500">æ—¥å‡ç—…äºº</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold {% if avg_completion >= 80 %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ avg_completion }}%
        </div>
        <div class="text-sm text-gray-500">å¹³å‡å®Œæˆç‡</div>
    </div>
</div>

<!-- æ¯æ—¥è©³ç´°åˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b">
        <span class="font-bold text-gray-700">æ¯æ—¥è©³ç´°æ•¸æ“š</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-center">ç¸½ç—…äºº</th>
                    <th class="px-4 py-3 text-center">å·²å®Œæˆ</th>
                    <th class="px-4 py-3 text-center">é€²è¡Œä¸­</th>
                    <th class="px-4 py-3 text-center">æœªé–‹å§‹</th>
                    <th class="px-4 py-3 text-center">å®Œæˆç‡</th>
                    <th class="px-4 py-3 text-center">è¨­å‚™æ•…éšœ</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                {% for summary in daily_summaries|reverse %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">
                        {{ summary.date.strftime('%Y-%m-%d') }}
                        {% if summary.date == today %}
                        <span class="text-xs text-green-500">(ä»Šæ—¥)</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">{{ summary.patients.total }}</td>
                    <td class="px-4 py-3 text-center text-green-600">{{ summary.patients.completed }}</td>
                    <td class="px-4 py-3 text-center text-yellow-600">{{ summary.patients.in_progress }}</td>
                    <td class="px-4 py-3 text-center text-gray-400">{{ summary.patients.not_started }}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs font-medium
                                    {% if summary.patients.completion_rate >= 80 %}bg-green-100 text-green-700
                                    {% elif summary.patients.completion_rate >= 50 %}bg-yellow-100 text-yellow-700
                                    {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ summary.patients.completion_rate }}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if summary.equipment.broken > 0 %}
                        <span class="text-red-500">{{ summary.equipment.broken }}</span>
                        {% else %}
                        <span class="text-green-500">0</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
