{% extends "base.html" %}

{% block title %}è¶¨å‹¢å ±è¡¨ - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“ˆ è¶¨å‹¢å ±è¡¨</h1>
    <a href="/admin/reports" class="text-blue-500 hover:underline">â† è¿”å›å ±è¡¨</a>
</div>

<!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
<div class="flex flex-wrap gap-2 mb-6">
    <a href="/admin/reports/trend?days=7"
       class="px-4 py-2 rounded-lg {% if days == 7 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        7 å¤©
    </a>
    <a href="/admin/reports/trend?days=14"
       class="px-4 py-2 rounded-lg {% if days == 14 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        14 å¤©
    </a>
    <a href="/admin/reports/trend?days=30"
       class="px-4 py-2 rounded-lg {% if days == 30 %}bg-blue-500 text-white{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        30 å¤©
    </a>
    <a href="/admin/dashboard"
       class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg ml-4">
        ğŸ“Š å³æ™‚å„€è¡¨æ¿
    </a>
</div>

<div class="text-sm text-gray-500 mb-4">
    ğŸ“… {{ start_date }} ~ {{ end_date }}
</div>

<!-- çµ±è¨ˆæ‘˜è¦ -->
{% set total_patients = daily_summaries|map(attribute='patients.total')|sum %}
{% set total_completed = daily_summaries|map(attribute='patients.completed')|sum %}
{% set avg_patients = (total_patients / days)|round(1) %}
{% set avg_completion = (total_completed / total_patients * 100)|round(1) if total_patients > 0 else 0 %}

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-blue-600">{{ total_patients }}</div>
        <div class="text-sm text-gray-500">ç¸½ç—…äººæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-green-600">{{ total_completed }}</div>
        <div class="text-sm text-gray-500">ç¸½å®Œæˆæ•¸</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold text-purple-600">{{ avg_patients }}</div>
        <div class="text-sm text-gray-500">æ—¥å‡ç—…äºº</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-2xl font-bold {% if avg_completion >= 80 %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ avg_completion }}%
        </div>
        <div class="text-sm text-gray-500">å¹³å‡å®Œæˆç‡</div>
    </div>
</div>

<!-- Chart.js åœ–è¡¨ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- ç—…äººæ•¸èˆ‡å®Œæˆæ•¸è¶¨å‹¢ -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š ç—…äººæ•¸è¶¨å‹¢</h3>
        <canvas id="patientChart" height="250"></canvas>
    </div>
    
    <!-- å®Œæˆç‡è¶¨å‹¢ -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">ğŸ“ˆ å®Œæˆç‡è¶¨å‹¢</h3>
        <canvas id="rateChart" height="250"></canvas>
    </div>
</div>

<!-- æ¯æ—¥è©³ç´°åˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b">
        <span class="font-bold text-gray-700">æ¯æ—¥è©³ç´°æ•¸æ“š</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-center">ç¸½ç—…äºº</th>
                    <th class="px-4 py-3 text-center">å·²å®Œæˆ</th>
                    <th class="px-4 py-3 text-center">é€²è¡Œä¸­</th>
                    <th class="px-4 py-3 text-center">æœªé–‹å§‹</th>
                    <th class="px-4 py-3 text-center">å®Œæˆç‡</th>
                    <th class="px-4 py-3 text-center">è¨­å‚™æ•…éšœ</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                {% for summary in daily_summaries|reverse %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">
                        {{ summary.date.strftime('%Y-%m-%d') }}
                        {% if summary.date == today %}
                        <span class="text-xs text-green-500">(ä»Šæ—¥)</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">{{ summary.patients.total }}</td>
                    <td class="px-4 py-3 text-center text-green-600">{{ summary.patients.completed }}</td>
                    <td class="px-4 py-3 text-center text-yellow-600">{{ summary.patients.in_progress }}</td>
                    <td class="px-4 py-3 text-center text-gray-400">{{ summary.patients.not_started }}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs font-medium
                                    {% if summary.patients.completion_rate >= 80 %}bg-green-100 text-green-700
                                    {% elif summary.patients.completion_rate >= 50 %}bg-yellow-100 text-yellow-700
                                    {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ summary.patients.completion_rate }}%
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if summary.equipment.broken > 0 %}
                        <span class="text-red-500">{{ summary.equipment.broken }}</span>
                        {% else %}
                        <span class="text-green-500">0</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// æº–å‚™åœ–è¡¨è³‡æ–™
const labels = {{ daily_summaries | map(attribute='date') | map('strftime', '%m/%d') | list | tojson }};
const patientsData = {{ daily_summaries | map(attribute='patients.total') | list | tojson }};
const completedData = {{ daily_summaries | map(attribute='patients.completed') | list | tojson }};
const rateData = {{ daily_summaries | map(attribute='patients.completion_rate') | list | tojson }};

// ç—…äººæ•¸è¶¨å‹¢åœ–
const patientCtx = document.getElementById('patientChart').getContext('2d');
new Chart(patientCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'ç¸½ç—…äººæ•¸',
                data: patientsData,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
            },
            {
                label: 'å®Œæˆæ•¸',
                data: completedData,
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.3,
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// å®Œæˆç‡è¶¨å‹¢åœ–
const rateCtx = document.getElementById('rateChart').getContext('2d');
new Chart(rateCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'å®Œæˆç‡ (%)',
                data: rateData,
                borderColor: 'rgb(168, 85, 247)',
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                fill: true,
                tension: 0.3,
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
