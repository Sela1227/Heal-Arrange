{% extends "base.html" %}

{% block title %}å¸³è™Ÿç®¡ç† - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¥ å¸³è™Ÿç®¡ç†</h1>
    <a href="/admin" class="text-blue-500 hover:underline">â† è¿”å›ç®¡ç†å¾Œå°</a>
</div>

<!-- è§’è‰²èªªæ˜ -->
<div class="bg-blue-50 rounded-xl p-4 mb-6">
    <h3 class="font-bold text-blue-800 mb-2">è§’è‰²èªªæ˜</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div class="flex items-center">
            <span class="px-2 py-1 bg-red-100 text-red-700 rounded mr-2">admin</span>
            <span class="text-gray-600">ç®¡ç†å“¡ - å…¨éƒ¨æ¬Šé™</span>
        </div>
        <div class="flex items-center">
            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded mr-2">dispatcher</span>
            <span class="text-gray-600">èª¿åº¦å“¡ - æŒ‡æ´¾ç—…äºº</span>
        </div>
        <div class="flex items-center">
            <span class="px-2 py-1 bg-green-100 text-green-700 rounded mr-2">coordinator</span>
            <span class="text-gray-600">å°ˆå“¡ - é™ªåŒç—…äºº</span>
        </div>
        <div class="flex items-center">
            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded mr-2">pending</span>
            <span class="text-gray-600">å¾…å¯©æ ¸</span>
        </div>
    </div>
</div>

<!-- ç”¨æˆ¶åˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç”¨æˆ¶</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">LINE ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è§’è‰²</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¨»å†Šæ™‚é–“</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for u in users %}
            <tr class="hover:bg-gray-50 {% if not u.is_active %}opacity-50{% endif %}">
                <!-- ç”¨æˆ¶è³‡è¨Š -->
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        {% if u.picture_url %}
                        <img src="{{ u.picture_url }}" alt="" class="w-10 h-10 rounded-full mr-3">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-gray-200 mr-3 flex items-center justify-center">
                            <span class="text-gray-500">ğŸ‘¤</span>
                        </div>
                        {% endif %}
                        <div>
                            <div class="font-medium">{{ u.display_name or 'æœªè¨­å®š' }}</div>
                            <div class="text-xs text-gray-400">ID: {{ u.id }}</div>
                        </div>
                    </div>
                </td>
                
                <!-- LINE ID -->
                <td class="px-4 py-3 text-gray-500 text-xs font-mono">
                    {{ u.line_user_id[:20] }}...
                </td>
                
                <!-- è§’è‰² -->
                <td class="px-4 py-3">
                    <form action="/admin/users/{{ u.id }}/role" method="POST">
                        <select name="role" 
                                onchange="this.form.submit()"
                                class="border rounded px-2 py-1 text-sm
                                       {% if u.role == 'admin' %}bg-red-50 text-red-700 border-red-200
                                       {% elif u.role == 'dispatcher' %}bg-blue-50 text-blue-700 border-blue-200
                                       {% elif u.role == 'coordinator' %}bg-green-50 text-green-700 border-green-200
                                       {% elif u.role == 'pending' %}bg-yellow-50 text-yellow-700 border-yellow-200
                                       {% endif %}"
                                {% if u.id == user.id %}disabled{% endif %}>
                            <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>ç®¡ç†å“¡</option>
                            <option value="dispatcher" {% if u.role == 'dispatcher' %}selected{% endif %}>èª¿åº¦å“¡</option>
                            <option value="coordinator" {% if u.role == 'coordinator' %}selected{% endif %}>å°ˆå“¡</option>
                            <option value="pending" {% if u.role == 'pending' %}selected{% endif %}>å¾…å¯©æ ¸</option>
                        </select>
                    </form>
                </td>
                
                <!-- ç‹€æ…‹ -->
                <td class="px-4 py-3">
                    {% if u.is_active %}
                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">å•Ÿç”¨</span>
                    {% else %}
                    <span class="px-2 py-1 bg-gray-100 text-gray-500 rounded text-xs">åœç”¨</span>
                    {% endif %}
                </td>
                
                <!-- è¨»å†Šæ™‚é–“ -->
                <td class="px-4 py-3 text-gray-500 text-sm">
                    {{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else '-' }}
                </td>
                
                <!-- æ“ä½œ -->
                <td class="px-4 py-3">
                    {% if u.id != user.id %}
                    <form action="/admin/users/{{ u.id }}/toggle" method="POST" class="inline">
                        {% if u.is_active %}
                        <button type="submit" 
                                class="text-red-500 hover:text-red-700 text-sm"
                                onclick="return confirm('ç¢ºå®šè¦åœç”¨æ­¤å¸³è™Ÿï¼Ÿ')">
                            åœç”¨
                        </button>
                        {% else %}
                        <button type="submit" 
                                class="text-green-500 hover:text-green-700 text-sm">
                            å•Ÿç”¨
                        </button>
                        {% endif %}
                    </form>
                    {% else %}
                    <span class="text-gray-400 text-sm">ï¼ˆè‡ªå·±ï¼‰</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- çµ±è¨ˆ -->
<div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
    {% set admin_count = users|selectattr('role', 'equalto', 'admin')|list|length %}
    {% set dispatcher_count = users|selectattr('role', 'equalto', 'dispatcher')|list|length %}
    {% set coordinator_count = users|selectattr('role', 'equalto', 'coordinator')|list|length %}
    {% set pending_count = users|selectattr('role', 'equalto', 'pending')|list|length %}
    
    <div class="bg-red-50 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-red-600">{{ admin_count }}</div>
        <div class="text-sm text-red-500">ç®¡ç†å“¡</div>
    </div>
    <div class="bg-blue-50 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-600">{{ dispatcher_count }}</div>
        <div class="text-sm text-blue-500">èª¿åº¦å“¡</div>
    </div>
    <div class="bg-green-50 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600">{{ coordinator_count }}</div>
        <div class="text-sm text-green-500">å°ˆå“¡</div>
    </div>
    <div class="bg-yellow-50 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600">{{ pending_count }}</div>
        <div class="text-sm text-yellow-500">å¾…å¯©æ ¸</div>
    </div>
</div>
{% endblock %}
