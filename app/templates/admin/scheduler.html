{% extends "base.html" %}

{% block title %}æ’ç¨‹å»ºè­° - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ§  æ™ºæ…§æ’ç¨‹å»ºè­°</h1>
    <a href="/admin" class="text-blue-500 hover:underline">â† è¿”å›ç®¡ç†å¾Œå°</a>
</div>

<!-- æ•´é«”ç‹€æ…‹æ‘˜è¦ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-3xl font-bold text-blue-600">{{ optimization.total_patients }}</div>
        <div class="text-sm text-gray-500">ä»Šæ—¥ç¸½ç—…äºº</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-3xl font-bold text-purple-600">{{ optimization.estimated_completion_time }}</div>
        <div class="text-sm text-gray-500">é ä¼°å®Œæˆæ™‚é–“</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-3xl font-bold {% if optimization.bottlenecks|length > 0 %}text-red-600{% else %}text-green-600{% endif %}">
            {{ optimization.bottlenecks|length }}
        </div>
        <div class="text-sm text-gray-500">ç“¶é ¸ç«™é»</div>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <div class="text-3xl font-bold text-green-600">
            {{ capacity_status|selectattr('status', 'equalto', 'normal')|list|length }}
        </div>
        <div class="text-sm text-gray-500">æ­£å¸¸é‹ä½œç«™é»</div>
    </div>
</div>

<!-- ç“¶é ¸è­¦ç¤º -->
{% if optimization.bottlenecks %}
<div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
    <h3 class="font-bold text-red-800 mb-3">âš ï¸ ç“¶é ¸ç«™é»è­¦ç¤º</h3>
    <div class="space-y-3">
        {% for bottleneck in optimization.bottlenecks %}
        <div class="bg-white rounded-lg p-3 border border-red-100">
            <div class="flex justify-between items-start">
                <div>
                    <span class="font-bold text-red-700">{{ bottleneck.exam_name }}</span>
                    <span class="text-gray-500">({{ bottleneck.exam_code }})</span>
                </div>
                <span class="px-2 py-1 rounded text-xs {% if bottleneck.severity == 'high' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                    {% if bottleneck.severity == 'high' %}åš´é‡{% else %}ä¸­ç­‰{% endif %}
                </span>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span>å‰©é¤˜ {{ bottleneck.remaining }} äºº</span>
                <span class="mx-2">â€¢</span>
                <span>é ä¼°éœ€ {{ bottleneck.estimated_minutes }} åˆ†é˜</span>
            </div>
            <div class="mt-1 text-sm text-blue-600">
                ğŸ’¡ {{ bottleneck.suggestion }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- å®¹é‡ç‹€æ…‹ -->
<div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š å„ç«™å®¹é‡ç‹€æ…‹</h3>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        {% for station in capacity_status %}
        <div class="border rounded-lg p-3 {% if station.status == 'full' %}border-red-300 bg-red-50{% elif station.status == 'busy' %}border-yellow-300 bg-yellow-50{% else %}border-green-300 bg-green-50{% endif %}">
            <div class="flex justify-between items-start">
                <div>
                    <div class="font-bold">{{ station.exam_code }}</div>
                    <div class="text-xs text-gray-500">{{ station.exam_name }}</div>
                </div>
                <span class="text-lg">
                    {% if station.status == 'full' %}ğŸ”´
                    {% elif station.status == 'busy' %}ğŸŸ¡
                    {% else %}ğŸŸ¢{% endif %}
                </span>
            </div>
            <div class="mt-2 grid grid-cols-2 gap-1 text-xs">
                <div class="text-gray-500">ç­‰å€™ä¸­</div>
                <div class="text-right font-medium">{{ station.waiting }}</div>
                <div class="text-gray-500">æª¢æŸ¥ä¸­</div>
                <div class="text-right font-medium">{{ station.in_exam }}</div>
                <div class="text-gray-500">å®¹é‡</div>
                <div class="text-right font-medium">{{ station.capacity }}</div>
            </div>
            <!-- é€²åº¦æ¢ -->
            <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all {% if station.status == 'full' %}bg-red-500{% elif station.status == 'busy' %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                     style="width: {{ [station.utilization, 100]|min }}%"></div>
            </div>
            <div class="text-right text-xs mt-1 {% if station.status == 'full' %}text-red-600{% elif station.status == 'busy' %}text-yellow-600{% else %}text-green-600{% endif %}">
                {{ station.utilization }}%
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ç—…äººæ’ç¨‹å»ºè­°ï¼ˆå¦‚æœæœ‰é¸æ“‡ç—…äººï¼‰ -->
{% if selected_patient %}
<div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 class="font-bold text-gray-700 mb-4">
        ğŸ¯ {{ selected_patient.name }} çš„ä¸‹ä¸€ç«™å»ºè­°
    </h3>
    
    <!-- è¡çªè­¦ç¤º -->
    {% if conflicts %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
        <div class="font-bold text-yellow-800 mb-2">âš ï¸ æ’ç¨‹æ³¨æ„äº‹é …</div>
        {% for conflict in conflicts %}
        <div class="text-sm {% if conflict.severity == 'error' %}text-red-600{% else %}text-yellow-700{% endif %}">
            â€¢ {{ conflict.message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- å»ºè­°åˆ—è¡¨ -->
    <div class="space-y-2">
        {% for suggestion in suggestions %}
        <div class="flex items-center justify-between p-3 rounded-lg border {% if loop.first %}border-green-300 bg-green-50{% else %}border-gray-200{% endif %}">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">
                    {% if loop.first %}ğŸ¥‡{% elif loop.index == 2 %}ğŸ¥ˆ{% elif loop.index == 3 %}ğŸ¥‰{% else %}{{ loop.index }}{% endif %}
                </div>
                <div>
                    <div class="font-bold">{{ suggestion.exam_name }}</div>
                    <div class="text-sm text-gray-500">
                        {{ suggestion.exam_code }} â€¢ {{ suggestion.duration_minutes }}åˆ†é˜ 
                        â€¢ ç­‰å€™{{ suggestion.waiting_count }}äºº
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-lg font-bold {% if suggestion.score >= 80 %}text-green-600{% elif suggestion.score >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ suggestion.score }}åˆ†
                </div>
                <div class="text-xs text-gray-500 max-w-48">{{ suggestion.reason }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- é¸æ“‡ç—…äºº -->
<div class="bg-white rounded-xl shadow p-4">
    <h3 class="font-bold text-gray-700 mb-4">ğŸ” æŸ¥è©¢ç—…äººæ’ç¨‹å»ºè­°</h3>
    <form method="GET" class="flex items-end space-x-4">
        <div>
            <label class="block text-sm text-gray-600 mb-1">é¸æ“‡ç—…äºº</label>
            <select name="patient_id" class="border rounded-lg px-3 py-2 w-64">
                <option value="">-- é¸æ“‡ç—…äºº --</option>
                {% for patient in patients %}
                <option value="{{ patient.id }}" {% if selected_patient and selected_patient.id == patient.id %}selected{% endif %}>
                    {{ patient.chart_no }} - {{ patient.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
            ğŸ§  å–å¾—å»ºè­°
        </button>
    </form>
</div>

<!-- èªªæ˜ -->
<div class="mt-6 bg-blue-50 rounded-xl p-4 text-sm text-blue-800">
    <h4 class="font-bold mb-2">ğŸ’¡ æ’ç¨‹å»ºè­°èªªæ˜</h4>
    <ul class="list-disc list-inside space-y-1">
        <li><strong>åˆ†æ•¸è¨ˆç®—</strong>ï¼šæ ¹æ“šç­‰å€™äººæ•¸ã€ä¾è³´é—œä¿‚ã€è¨­å‚™ç‹€æ…‹ã€æ™‚é–“å› ç´ ç¶œåˆè¨ˆç®—</li>
        <li><strong>ä¾è³´é—œä¿‚</strong>ï¼šå¦‚å…§è¦–é¡æ‡‰åœ¨æŠ½è¡€å¾Œã€è«®è©¢æ‡‰åœ¨æ‰€æœ‰æª¢æŸ¥å¾Œ</li>
        <li><strong>ç“¶é ¸åˆ†æ</strong>ï¼šé æ¸¬å“ªäº›ç«™é»å¯èƒ½é€ æˆå»¶é²</li>
        <li><strong>å»ºè­°æ›´æ–°</strong>ï¼šé é¢æ¯ 30 ç§’è‡ªå‹•æ›´æ–°æ•¸æ“š</li>
    </ul>
</div>

<script>
// æ¯ 30 ç§’é‡æ–°è¼‰å…¥é é¢
setTimeout(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
