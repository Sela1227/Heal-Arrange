{% extends "base.html" %}

{% block title %}ç—…äººç®¡ç† - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ ç—…äººç®¡ç†</h1>
    <a href="/admin" class="text-blue-500 hover:underline">â† è¿”å›ç®¡ç†å¾Œå°</a>
</div>

{% if imported %}
<div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-xl mb-4">
    âœ… æˆåŠŸåŒ¯å…¥ {{ imported }} ç­†è³‡æ–™
    {% if errors > 0 %}
    <span class="text-orange-600">ï¼ˆ{{ errors }} ç­†éŒ¯èª¤ï¼‰</span>
    {% endif %}
</div>
{% endif %}

<!-- CSV åŒ¯å…¥ -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-700 mb-4">ğŸ“¤ CSV åŒ¯å…¥</h2>
    <form action="/admin/patients/import" method="POST" enctype="multipart/form-data" 
          class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm text-gray-600 mb-1">æª¢æŸ¥æ—¥æœŸ</label>
            <input type="date" name="exam_date" value="{{ today }}" required
                   class="border rounded-lg px-3 py-2">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">CSV æª”æ¡ˆ</label>
            <input type="file" name="file" accept=".csv" required
                   class="border rounded-lg px-3 py-2">
        </div>
        <button type="submit"
                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
            ğŸ“¤ åŒ¯å…¥
        </button>
        <a href="/admin/patients/template"
           class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">
            ğŸ“¥ ä¸‹è¼‰ç¯„æœ¬
        </a>
    </form>
</div>

<!-- æ‰‹å‹•æ–°å¢ -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-700 mb-4">â• æ‰‹å‹•æ–°å¢ç—…äºº</h2>
    <form action="/admin/patients/add" method="POST" class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm text-gray-600 mb-1">ç—…æ­·è™Ÿ</label>
            <input type="text" name="chart_no" required
                   placeholder="A12345678"
                   class="border rounded-lg px-3 py-2 w-32">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">å§“å</label>
            <input type="text" name="name" required
                   placeholder="ç‹å°æ˜"
                   class="border rounded-lg px-3 py-2 w-32">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">æª¢æŸ¥é …ç›®</label>
            <input type="text" name="exam_list"
                   placeholder="CT,MRI,US"
                   class="border rounded-lg px-3 py-2 w-40">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">æ—¥æœŸ</label>
            <input type="date" name="exam_date" value="{{ today }}" required
                   class="border rounded-lg px-3 py-2">
        </div>
        <button type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
            â• æ–°å¢
        </button>
    </form>
</div>

<!-- ç—…äººåˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
        <span class="font-bold text-gray-700">
            ğŸ“‹ ä»Šæ—¥ç—…äººåˆ—è¡¨ï¼ˆ{{ today }}ï¼‰
        </span>
        <span class="text-sm text-gray-500">å…± {{ patients|length }} äºº</span>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç—…æ­·è™Ÿ</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å§“å</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æª¢æŸ¥é …ç›®</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for patient in patients %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-mono">{{ patient.chart_no }}</td>
                    <td class="px-4 py-3 font-medium">{{ patient.name }}</td>
                    <td class="px-4 py-3">
                        {% if patient.exam_list %}
                        <div class="flex flex-wrap gap-1">
                            {% for code in patient.exam_list.split(',') %}
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">
                                {{ code.strip() }}
                            </span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <form action="/admin/patients/{{ patient.id }}/delete" method="POST" class="inline"
                              onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç—…äººï¼Ÿ')">
                            <button type="submit" class="text-red-500 hover:text-red-700 text-sm">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not patients %}
                <tr>
                    <td colspan="4" class="px-4 py-12 text-center text-gray-500">
                        <div class="text-4xl mb-4">ğŸ“­</div>
                        <p>ä»Šæ—¥å°šç„¡ç—…äºº</p>
                        <p class="text-sm">è«‹åŒ¯å…¥ CSV æˆ–æ‰‹å‹•æ–°å¢</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
