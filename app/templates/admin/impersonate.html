{% extends "base.html" %}

{% block title %}è§’è‰²æ¨¡æ“¬ - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ­ è§’è‰²æ¨¡æ“¬</h1>
    <a href="/admin" class="text-blue-500 hover:underline">â† è¿”å›ç®¡ç†å¾Œå°</a>
</div>

<!-- èªªæ˜ -->
<div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
    <div class="flex items-start">
        <span class="text-2xl mr-3">ğŸ’¡</span>
        <div>
            <h3 class="font-bold text-blue-800">åŠŸèƒ½èªªæ˜</h3>
            <p class="text-blue-700 text-sm mt-1">
                è§’è‰²æ¨¡æ“¬è®“ç®¡ç†å“¡å¯ä»¥åˆ‡æ›åˆ°å…¶ä»–è§’è‰²çš„è¦–è§’ï¼ŒæŸ¥çœ‹ä»–å€‘å¯¦éš›çœ‹åˆ°çš„ç•«é¢ã€‚
                é€™å°æ–¼ Debugã€åŸ¹è¨“å’Œä½¿ç”¨è€…é«”é©—æ¸¬è©¦éå¸¸æœ‰ç”¨ã€‚
            </p>
            <p class="text-blue-600 text-sm mt-2">
                âš ï¸ æ¨¡æ“¬æœŸé–“æœƒæœ‰æ˜é¡¯çš„ç´…è‰²æç¤ºæ¢ï¼Œæ‰€æœ‰æ“ä½œéƒ½æœƒä»¥è¢«æ¨¡æ“¬è€…çš„èº«ä»½é€²è¡Œã€‚
            </p>
        </div>
    </div>
</div>

{% if impersonate_status.is_impersonating %}
<!-- ç›®å‰æ­£åœ¨æ¨¡æ“¬ä¸­ -->
<div class="bg-red-50 border-2 border-red-300 rounded-xl p-6 mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <span class="text-3xl mr-4">ğŸ­</span>
            <div>
                <h3 class="font-bold text-red-800 text-lg">ç›®å‰æ­£åœ¨æ¨¡æ“¬ä¸­</h3>
                <p class="text-red-700">
                    è§’è‰²ï¼š<strong>{{ impersonate_status.role_name }}</strong>
                </p>
            </div>
        </div>
        <form action="/admin/impersonate/end" method="POST">
            <button type="submit" 
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold">
                ğŸ›‘ çµæŸæ¨¡æ“¬
            </button>
        </form>
    </div>
</div>
{% endif %}

<!-- é¸æ“‡è§’è‰² -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- èª¿åº¦å“¡ -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 bg-blue-500 text-white font-bold flex items-center">
            <span class="text-xl mr-2">ğŸ“Š</span>
            èª¿åº¦å“¡
        </div>
        <div class="p-4">
            <p class="text-gray-600 text-sm mb-4">
                ç—…äººæŒ‡æ´¾ã€å³æ™‚ç›£æ§ã€å ±è¡¨æŸ¥çœ‹
            </p>
            
            {% if dispatchers %}
            <form action="/admin/impersonate/start" method="POST">
                <input type="hidden" name="role" value="dispatcher">
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é¸æ“‡èª¿åº¦å“¡</label>
                    <select name="user_id" required
                            class="w-full border rounded-lg px-3 py-2">
                        {% for u in dispatchers %}
                        <option value="{{ u.id }}">{{ u.display_name or u.line_user_id }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-medium">
                    ğŸ­ é–‹å§‹æ¨¡æ“¬
                </button>
            </form>
            {% else %}
            <div class="text-center text-gray-400 py-4">
                <div class="text-3xl mb-2">ğŸ“­</div>
                <p>å°šç„¡èª¿åº¦å“¡å¸³è™Ÿ</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- å°ˆå“¡ï¼ˆåŸå€‹ç®¡å¸«ï¼‰ -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 bg-green-500 text-white font-bold flex items-center">
            <span class="text-xl mr-2">ğŸ‘¤</span>
            å°ˆå“¡
        </div>
        <div class="p-4">
            <p class="text-gray-600 text-sm mb-4">
                é™ªåŒç—…äººã€ç‹€æ…‹å›å ±ã€æ•…éšœé€šå ±
            </p>
            
            {% if coordinators %}
            <form action="/admin/impersonate/start" method="POST">
                <input type="hidden" name="role" value="coordinator">
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é¸æ“‡å°ˆå“¡</label>
                    <select name="user_id" required
                            class="w-full border rounded-lg px-3 py-2">
                        {% for u in coordinators %}
                        <option value="{{ u.id }}">{{ u.display_name or u.line_user_id }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium">
                    ğŸ­ é–‹å§‹æ¨¡æ“¬
                </button>
            </form>
            {% else %}
            <div class="text-center text-gray-400 py-4">
                <div class="text-3xl mb-2">ğŸ“­</div>
                <p>å°šç„¡å°ˆå“¡å¸³è™Ÿ</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- ç—…äºº -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 bg-purple-500 text-white font-bold flex items-center">
            <span class="text-xl mr-2">ğŸ¥</span>
            ç—…äºº
        </div>
        <div class="p-4">
            <p class="text-gray-600 text-sm mb-4">
                æŸ¥çœ‹æª¢æŸ¥é€²åº¦ã€ç­‰å€™æ™‚é–“ï¼ˆ{{ today }} ç•¶æ—¥ç—…äººï¼‰
            </p>
            
            {% if patients %}
            <form action="/admin/impersonate/start" method="POST">
                <input type="hidden" name="role" value="patient">
                <div class="mb-3">
                    <label class="block text-sm text-gray-600 mb-1">é¸æ“‡ç—…äºº</label>
                    <select name="patient_id" required
                            class="w-full border rounded-lg px-3 py-2">
                        {% for p in patients %}
                        <option value="{{ p.id }}">{{ p.name }} ({{ p.chart_no }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-medium">
                    ğŸ­ é–‹å§‹æ¨¡æ“¬
                </button>
            </form>
            {% else %}
            <div class="text-center text-gray-400 py-4">
                <div class="text-3xl mb-2">ğŸ“­</div>
                <p>ä»Šæ—¥å°šç„¡ç—…äºº</p>
                <p class="text-xs mt-1">è«‹å…ˆåœ¨ç—…äººç®¡ç†ä¸­åŒ¯å…¥</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ³¨æ„äº‹é … -->
<div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-xl p-4">
    <h3 class="font-bold text-yellow-800 mb-2">âš ï¸ æ³¨æ„äº‹é …</h3>
    <ul class="text-yellow-700 text-sm space-y-1">
        <li>â€¢ æ¨¡æ“¬æœŸé–“ï¼Œé é¢é ‚éƒ¨æœƒé¡¯ç¤ºç´…è‰²æç¤ºæ¢</li>
        <li>â€¢ æ¨¡æ“¬ä¸­çš„æ‰€æœ‰æ“ä½œæœƒä»¥è¢«æ¨¡æ“¬è€…çš„èº«ä»½é€²è¡Œ</li>
        <li>â€¢ é»æ“Šã€ŒçµæŸæ¨¡æ“¬ã€å¯éš¨æ™‚è¿”å›ç®¡ç†å“¡èº«ä»½</li>
        <li>â€¢ ç—…äººè§’è‰²æ¨¡æ“¬éœ€è¦å…ˆå®Œæˆ Phase 8ï¼ˆç—…äººè‡ªåŠ©ç³»çµ±ï¼‰</li>
    </ul>
</div>
{% endblock %}
