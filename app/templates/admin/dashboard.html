{% extends "base.html" %}

{% block title %}æ•ˆèƒ½å„€è¡¨æ¿ - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ“ˆ æ•ˆèƒ½å„€è¡¨æ¿</h1>
    <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-500">
            ğŸ• æ›´æ–°æ™‚é–“ï¼š<span id="update-time">{{ now.strftime('%H:%M:%S') }}</span>
        </span>
        <a href="/admin/reports" class="text-blue-500 hover:underline">â† è¿”å›å ±è¡¨</a>
    </div>
</div>

<!-- å³æ™‚ KPI å¡ç‰‡ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"
     hx-get="/admin/dashboard/api/kpi"
     hx-trigger="every 10s"
     hx-swap="innerHTML">
    {% include "partials/kpi_cards.html" %}
</div>

<!-- åœ–è¡¨å€åŸŸ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- æ¯æ—¥è¶¨å‹¢åœ– -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">ğŸ“Š è¿‘ 7 æ—¥è¶¨å‹¢</h3>
        <canvas id="dailyTrendChart" height="200"></canvas>
    </div>
    
    <!-- ä»Šæ—¥æ™‚æ®µåœ– -->
    <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4">â° ä»Šæ—¥å„æ™‚æ®µè™•ç†é‡</h3>
        <canvas id="hourlyChart" height="200"></canvas>
    </div>
</div>

<!-- æª¢æŸ¥ç«™æ•ˆèƒ½è¡¨ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
            ğŸ¥ æª¢æŸ¥ç«™æ•ˆèƒ½
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">æª¢æŸ¥ç«™</th>
                        <th class="px-4 py-2 text-center">å®Œæˆ</th>
                        <th class="px-4 py-2 text-center">ç­‰å€™</th>
                        <th class="px-4 py-2 text-center">è¨­å‚™</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for station in station_performance %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 font-medium">
                            {{ station.exam_name }}
                            <span class="text-xs text-gray-400">({{ station.exam_code }})</span>
                        </td>
                        <td class="px-4 py-2 text-center">
                            <span class="text-green-600 font-bold">{{ station.completed }}</span>
                        </td>
                        <td class="px-4 py-2 text-center">
                            {% if station.waiting > 0 %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">
                                {{ station.waiting }} äºº
                            </span>
                            {% else %}
                            <span class="text-gray-400">0</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2 text-center">
                            {% if station.equipment_status == 'normal' %}
                            <span class="text-green-500">ğŸŸ¢</span>
                            {% elif station.equipment_status == 'broken' %}
                            <span class="text-red-500">ğŸ”´</span>
                            {% else %}
                            <span class="text-yellow-500">ğŸŸ¡</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- å€‹ç®¡å¸«æ•ˆèƒ½è¡¨ -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
            ğŸ‘¥ å€‹ç®¡å¸«å·¥ä½œé‡
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">å§“å</th>
                        <th class="px-4 py-2 text-center">æŒ‡æ´¾æ•¸</th>
                        <th class="px-4 py-2 text-center">æ“ä½œæ•¸</th>
                        <th class="px-4 py-2 text-center">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for coord in coordinator_performance %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 font-medium">{{ coord.name }}</td>
                        <td class="px-4 py-2 text-center">{{ coord.assignments }}</td>
                        <td class="px-4 py-2 text-center">
                            <span class="text-blue-600 font-bold">{{ coord.operations }}</span>
                        </td>
                        <td class="px-4 py-2 text-center">
                            {% if coord.status == 'ç©ºé–’' %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">ç©ºé–’</span>
                            {% elif coord.status == 'æª¢æŸ¥ä¸­' %}
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">æª¢æŸ¥ä¸­</span>
                            {% elif coord.status == 'ç­‰å€™ä¸­' %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">ç­‰å€™ä¸­</span>
                            {% elif coord.status == 'å·²å®Œæˆ' %}
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">å·²å®Œæˆ</span>
                            {% else %}
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">{{ coord.status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not coordinator_performance %}
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-400">
                            å°šç„¡å€‹ç®¡å¸«è³‡æ–™
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿé€£çµ -->
<div class="flex flex-wrap gap-3">
    <a href="/admin/reports" 
       class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
        ğŸ“Š çµ±è¨ˆå ±è¡¨
    </a>
    <a href="/admin/reports/trend?days=30"
       class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm">
        ğŸ“ˆ 30æ—¥è¶¨å‹¢
    </a>
    <a href="/dispatcher"
       class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-sm">
        ğŸ“¡ èª¿åº¦å°
    </a>
</div>

<script>
// æ¯æ—¥è¶¨å‹¢åœ–
const dailyCtx = document.getElementById('dailyTrendChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: {{ chart_data.labels | tojson }},
        datasets: [
            {
                label: 'ç—…äººæ•¸',
                data: {{ chart_data.datasets.patients | tojson }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
            },
            {
                label: 'å®Œæˆæ•¸',
                data: {{ chart_data.datasets.completed | tojson }},
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                fill: true,
                tension: 0.3,
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// ä»Šæ—¥æ™‚æ®µåœ–
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: {{ hourly_data | map(attribute='label') | list | tojson }},
        datasets: [
            {
                label: 'å®Œæˆæ•¸',
                data: {{ hourly_data | map(attribute='completed') | list | tojson }},
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
            },
            {
                label: 'é–‹å§‹æ•¸',
                data: {{ hourly_data | map(attribute='started') | list | tojson }},
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// æ›´æ–°æ™‚é–“
setInterval(() => {
    const now = new Date();
    document.getElementById('update-time').textContent = 
        now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
}, 1000);
</script>
{% endblock %}
