{% extends "base.html" %}

{% block title %}æª¢æŸ¥é …ç›®ç®¡ç† - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ”¬ æª¢æŸ¥é …ç›®ç®¡ç†</h1>
    <a href="/admin" class="text-blue-500 hover:underline">â† è¿”å›ç®¡ç†å¾Œå°</a>
</div>

<!-- æ–°å¢è¡¨å–® -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-700 mb-4">æ–°å¢/ç·¨è¼¯æª¢æŸ¥é …ç›®</h2>
    <form action="/admin/exams/add" method="POST" class="flex flex-wrap gap-4 items-end">
        <div>
            <label class="block text-sm text-gray-600 mb-1">æª¢æŸ¥ä»£ç¢¼</label>
            <input type="text" name="exam_code" required
                   placeholder="å¦‚: CT"
                   class="border rounded-lg px-3 py-2 w-24">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">æª¢æŸ¥åç¨±</label>
            <input type="text" name="name" required
                   placeholder="å¦‚: é›»è…¦æ–·å±¤"
                   class="border rounded-lg px-3 py-2 w-32">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">é ä¼°æ™‚é–“(åˆ†)</label>
            <input type="number" name="duration_minutes" value="15" min="1"
                   class="border rounded-lg px-3 py-2 w-20">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">å®¹é‡ä¸Šé™</label>
            <input type="number" name="capacity" value="5" min="1" max="20"
                   class="border rounded-lg px-3 py-2 w-20"
                   title="åŒæ™‚å¯å®¹ç´çš„ç—…äººæ•¸">
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">ä½ç½®èªªæ˜</label>
            <input type="text" name="location"
                   placeholder="å¦‚: 1æ¨“å½±åƒä¸­å¿ƒ"
                   class="border rounded-lg px-3 py-2 w-32">
        </div>
        <button type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
            â• æ–°å¢
        </button>
    </form>
</div>

<!-- åˆå§‹åŒ–æŒ‰éˆ• -->
<div class="mb-6 flex items-center space-x-4">
    <form action="/admin/exams/init" method="POST" class="inline">
        <button type="submit"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
            ğŸš€ åˆå§‹åŒ–é è¨­æª¢æŸ¥é …ç›®
        </button>
    </form>
    <a href="/admin/scheduler"
       class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm">
        ğŸ§  æŸ¥çœ‹æ’ç¨‹å»ºè­°
    </a>
</div>

<!-- å®¹é‡ç‹€æ…‹ç¸½è¦½ -->
<div class="bg-white rounded-xl shadow p-4 mb-6">
    <h3 class="font-bold text-gray-700 mb-3">ğŸ“Š ä»Šæ—¥å®¹é‡ç‹€æ…‹</h3>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3"
         hx-get="/admin/exams/api/capacity"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
        {% for exam in exams %}
        {% if exam.is_active %}
        <div class="border rounded-lg p-3 {% if exam.capacity and (capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 100) %}border-red-300 bg-red-50{% elif capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 70 %}border-yellow-300 bg-yellow-50{% else %}border-gray-200{% endif %}">
            <div class="font-medium text-sm">{{ exam.exam_code }}</div>
            <div class="text-xs text-gray-500">{{ exam.name }}</div>
            <div class="mt-2 flex justify-between items-center">
                <span class="text-lg font-bold">
                    {{ capacity_status.get(exam.exam_code, {}).get('current_count', 0) }}/{{ exam.capacity or 5 }}
                </span>
                <span class="text-xs {% if capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 100 %}text-red-600{% elif capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 70 %}text-yellow-600{% else %}text-green-600{% endif %}">
                    {{ capacity_status.get(exam.exam_code, {}).get('utilization', 0) }}%
                </span>
            </div>
            <!-- é€²åº¦æ¢ -->
            <div class="mt-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full {% if capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 100 %}bg-red-500{% elif capacity_status.get(exam.exam_code, {}).get('utilization', 0) >= 70 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                     style="width: {{ [capacity_status.get(exam.exam_code, {}).get('utilization', 0), 100]|min }}%"></div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- æª¢æŸ¥é …ç›®åˆ—è¡¨ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä»£ç¢¼</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">åç¨±</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å®¹é‡</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä½ç½®</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for exam in exams %}
            <tr class="hover:bg-gray-50 {% if not exam.is_active %}opacity-50{% endif %}">
                <td class="px-4 py-3 font-mono font-bold text-blue-600">{{ exam.exam_code }}</td>
                <td class="px-4 py-3">{{ exam.name }}</td>
                <td class="px-4 py-3">{{ exam.duration_minutes }} åˆ†</td>
                <td class="px-4 py-3">
                    <form action="/admin/exams/{{ exam.id }}/capacity" method="POST" class="inline-flex items-center space-x-1">
                        <input type="number" name="capacity" value="{{ exam.capacity or 5 }}" 
                               min="1" max="20"
                               class="border rounded px-2 py-1 w-16 text-center text-sm">
                        <button type="submit" class="text-blue-500 hover:text-blue-700 text-sm">
                            ğŸ’¾
                        </button>
                    </form>
                </td>
                <td class="px-4 py-3 text-gray-500">{{ exam.location or '-' }}</td>
                <td class="px-4 py-3">
                    {% if exam.is_active %}
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">å•Ÿç”¨</span>
                    {% else %}
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">åœç”¨</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3">
                    {% if exam.is_active %}
                    <form action="/admin/exams/{{ exam.id }}/delete" method="POST" class="inline"
                          onsubmit="return confirm('ç¢ºå®šè¦åœç”¨æ­¤æª¢æŸ¥é …ç›®ï¼Ÿ')">
                        <button type="submit" class="text-red-500 hover:text-red-700 text-sm">
                            ğŸ—‘ï¸ åœç”¨
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            
            {% if not exams %}
            <tr>
                <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                    <div class="text-4xl mb-4">ğŸ“­</div>
                    <p>å°šç„¡æª¢æŸ¥é …ç›®</p>
                    <p class="text-sm">é»æ“Šä¸Šæ–¹ã€Œåˆå§‹åŒ–é è¨­æª¢æŸ¥é …ç›®ã€å»ºç«‹</p>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- å®¹é‡èªªæ˜ -->
<div class="mt-6 bg-blue-50 rounded-xl p-4 text-sm text-blue-800">
    <h4 class="font-bold mb-2">ğŸ’¡ å®¹é‡ç®¡ç†èªªæ˜</h4>
    <ul class="list-disc list-inside space-y-1">
        <li><strong>å®¹é‡ä¸Šé™</strong>ï¼šè©²æª¢æŸ¥ç«™åŒæ™‚å¯å®¹ç´çš„ç—…äººæ•¸ï¼ˆç­‰å€™ä¸­ + æª¢æŸ¥ä¸­ï¼‰</li>
        <li><strong>åˆ©ç”¨ç‡</strong>ï¼šç›®å‰äººæ•¸ / å®¹é‡ä¸Šé™ Ã— 100%</li>
        <li>ğŸŸ¢ æ­£å¸¸ï¼ˆ< 70%ï¼‰ã€ğŸŸ¡ ç¹å¿™ï¼ˆ70-99%ï¼‰ã€ğŸ”´ å·²æ»¿ï¼ˆâ‰¥ 100%ï¼‰</li>
        <li>ç³»çµ±æœƒåœ¨æŒ‡æ´¾ä¸‹ä¸€ç«™æ™‚æé†’å·²æ»¿çš„æª¢æŸ¥ç«™</li>
    </ul>
</div>
{% endblock %}
