{% extends "base.html" %}

{% block title %}æˆ‘çš„ç—…äºº - é«˜æª¢ç—…äººå‹•æ…‹ç³»çµ±{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¤ å°ˆå“¡ - æˆ‘çš„ç—…äºº</h1>
    <p class="text-gray-500 mt-1">{{ today.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</p>
</div>

<!-- é€šçŸ¥å€åŸŸï¼ˆHTMX å³æ™‚æ›´æ–°ï¼‰ -->
<div id="notifications"
     hx-get="/coordinator/api/notifications"
     hx-trigger="every 3s"
     hx-swap="innerHTML">
    {% include "partials/notifications.html" %}
</div>

{% if patient_info and patient_info.patient %}
<!-- æœ‰è² è²¬çš„ç—…äºº -->
<div class="bg-white rounded-xl shadow overflow-hidden mb-6">
    <div class="px-4 py-3 bg-green-500 text-white font-bold flex items-center justify-between">
        <span>ğŸ¥ æˆ‘çš„ç—…äºº</span>
        <span class="text-sm font-normal">{{ patient_info.patient.chart_no }}</span>
    </div>
    
    <div class="p-6">
        <!-- ç—…äººè³‡è¨Š -->
        <div class="flex items-center mb-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-3xl mr-4">
                ğŸ‘¤
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{{ patient_info.patient.name }}</h2>
                <p class="text-gray-500">
                    æª¢æŸ¥é …ç›®ï¼š{{ patient_info.patient.exam_list or 'æœªè¨­å®š' }}
                </p>
            </div>
        </div>
        
        <!-- ç›®å‰ç‹€æ…‹ -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm text-gray-500 mb-1">ç›®å‰ç‹€æ…‹</div>
                <div class="text-xl font-bold">
                    {% if patient_info.tracking %}
                        {% if patient_info.tracking.current_status == 'waiting' %}
                        <span class="text-yellow-600">â³ ç­‰å€™ä¸­</span>
                        {% elif patient_info.tracking.current_status == 'in_exam' %}
                        <span class="text-red-600">ğŸ”¬ æª¢æŸ¥ä¸­</span>
                        {% elif patient_info.tracking.current_status == 'moving' %}
                        <span class="text-blue-600">ğŸš¶ ç§»å‹•ä¸­</span>
                        {% elif patient_info.tracking.current_status == 'completed' %}
                        <span class="text-green-600">âœ… å®Œæˆ</span>
                        {% endif %}
                    {% else %}
                    <span class="text-gray-400">æœªé–‹å§‹</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm text-gray-500 mb-1">ç›®å‰ä½ç½®</div>
                <div class="text-xl font-bold text-blue-600">
                    {% if patient_info.tracking and patient_info.tracking.current_location %}
                    ğŸ“ {{ patient_info.tracking.current_location }}
                    {% if exams_dict and patient_info.tracking.current_location in exams_dict %}
                    <span class="text-sm font-normal text-gray-500">
                        ({{ exams_dict[patient_info.tracking.current_location].name }})
                    </span>
                    {% endif %}
                    {% else %}
                    <span class="text-gray-400">-</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- ä¸‹ä¸€ç«™ -->
        {% if patient_info.tracking and patient_info.tracking.next_exam_code %}
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <span class="text-2xl mr-3">â¡ï¸</span>
                <div>
                    <div class="text-sm text-purple-600">ä¸‹ä¸€ç«™</div>
                    <div class="text-xl font-bold text-purple-800">
                        {{ patient_info.tracking.next_exam_code }}
                        {% if exams_dict and patient_info.tracking.next_exam_code in exams_dict %}
                        - {{ exams_dict[patient_info.tracking.next_exam_code].name }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ç‹€æ…‹å›å ±æŒ‰éˆ• -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <form action="/coordinator/arrive" method="POST">
                <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold text-lg transition">
                    ğŸ“ åˆ°é”
                </button>
            </form>
            
            <form action="/coordinator/start" method="POST">
                <button type="submit"
                        class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold text-lg transition">
                    ğŸ”¬ é–‹å§‹
                </button>
            </form>
            
            <form action="/coordinator/complete" method="POST">
                <button type="submit"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg transition">
                    âœ… å®Œæˆ
                </button>
            </form>
        </div>
        
        <!-- æ•…éšœå›å ± -->
        {% if current_equipment %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h3 class="font-bold text-yellow-800 mb-2">âš ï¸ è¨­å‚™æ•…éšœå›å ±</h3>
            <form action="/coordinator/report-equipment-failure" method="POST" class="flex gap-2">
                <select name="equipment_id" required class="flex-1 border rounded-lg px-3 py-2">
                    <option value="">é¸æ“‡æ•…éšœè¨­å‚™</option>
                    {% for eq in current_equipment %}
                    <option value="{{ eq.id }}">{{ eq.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium">
                    å›å ±
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- ä»Šæ—¥æ­·ç¨‹ -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b font-bold text-gray-700">
        ğŸ“œ ä»Šæ—¥æ­·ç¨‹
    </div>
    <div class="divide-y max-h-64 overflow-y-auto">
        {% for h in history %}
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center">
                {% if h.action == 'arrive' %}
                <span class="text-xl mr-3">ğŸ“</span>
                <span class="text-blue-600">åˆ°é”</span>
                {% elif h.action == 'start' %}
                <span class="text-xl mr-3">ğŸ”¬</span>
                <span class="text-red-600">é–‹å§‹æª¢æŸ¥</span>
                {% elif h.action == 'complete' %}
                <span class="text-xl mr-3">âœ…</span>
                <span class="text-green-600">å®Œæˆ</span>
                {% elif h.action == 'assign' %}
                <span class="text-xl mr-3">ğŸ“‹</span>
                <span class="text-purple-600">æŒ‡æ´¾</span>
                {% else %}
                <span class="text-xl mr-3">ğŸ“</span>
                <span>{{ h.action }}</span>
                {% endif %}
                
                {% if h.location %}
                <span class="ml-2 text-gray-500">@ {{ h.location }}</span>
                {% endif %}
            </div>
            <span class="text-sm text-gray-400">
                {{ h.timestamp.strftime('%H:%M') }}
            </span>
        </div>
        {% endfor %}
        
        {% if not history %}
        <div class="px-4 py-8 text-center text-gray-400">
            å°šç„¡æ­·ç¨‹è¨˜éŒ„
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<!-- ç›®å‰æ²’æœ‰è² è²¬çš„ç—…äºº -->
<div class="bg-white rounded-xl shadow p-12 text-center">
    <div class="text-6xl mb-4">ğŸ“­</div>
    <h2 class="text-xl font-bold text-gray-600 mb-2">ç›®å‰æ²’æœ‰è² è²¬çš„ç—…äºº</h2>
    <p class="text-gray-500">è«‹ç­‰å¾…èª¿åº¦å“¡æŒ‡æ´¾ç—…äººçµ¦æ‚¨</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// é é¢è‡ªå‹•åˆ·æ–°ï¼ˆæ¯ 30 ç§’ï¼‰
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
