# ğŸ”§ å®Œæ•´æ›´æ–°åŒ… v4

## ğŸ“‹ æ›´æ–°å…§å®¹

### 1. æ–°å¢ã€Œçµ„é•·ã€è§’è‰² ğŸ‘‘
- **çµ„é•· (leader)** = èª¿åº¦å“¡ + å°ˆå“¡ æ¬Šé™
- çµ„é•·å¯ä»¥åŒæ™‚å­˜å–èª¿åº¦å°å’Œå°ˆå“¡é é¢
- åœ¨å¸³è™Ÿç®¡ç†ä¸­æ–°å¢çµ„é•·é¸é …

### 2. æ–°ç”¨æˆ¶é è¨­ç‚ºã€Œçµ„é•·ã€
- æ¸¬è©¦éšæ®µï¼Œæ‰€æœ‰æ–°è¨»å†Šç”¨æˆ¶è‡ªå‹•è¨­ç‚ºçµ„é•·
- ä¹‹å¾Œå¯åœ¨å¸³è™Ÿç®¡ç†ä¸­èª¿æ•´

### 3. ä¿®æ­£è§’è‰²æ¨¡æ“¬åŠŸèƒ½ ğŸ­
- ä¿®æ­£ `start_impersonation` å‡½æ•¸åç¨±å•é¡Œ
- ä½¿ç”¨ Cookie å„²å­˜æ¨¡æ“¬ç‹€æ…‹ï¼ˆé Sessionï¼‰
- æ”¯æ´æ¨¡æ“¬çµ„é•·ã€èª¿åº¦å“¡ã€å°ˆå“¡

### 4. å€‹ç®¡å¸« â†’ å°ˆå“¡
- å…¨ç³»çµ±çµ±ä¸€åç¨±

### 5. å ±è¡¨æ¬„ä½ä¿®æ­£
- `duration_minutes` â†’ `duration_min` ç›¸å®¹è™•ç†

---

## ğŸ“ æª”æ¡ˆæ¸…å–®

```
v4-complete/
â”œâ”€â”€ README.md                           # æœ¬èªªæ˜æ–‡æª”
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ user.py                     # âœ… æ–°å¢ leader è§’è‰²
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth.py                     # âœ… æ–°ç”¨æˆ¶é è¨­çµ„é•· + è§’è‰²æª¢æŸ¥
â”‚   â”‚   â”œâ”€â”€ impersonate.py              # âœ… ä¿®æ­£æ¨¡æ“¬åŠŸèƒ½
â”‚   â”‚   â””â”€â”€ stats.py                    # âœ… æ”¯æ´çµ„é•· + æ¬„ä½ä¿®æ­£
â”‚   â”‚
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ admin.py                    # âœ… å®Œæ•´ç®¡ç†è·¯ç”± + æ¨¡æ“¬åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ dispatcher.py               # âœ… æ”¯æ´çµ„é•·å­˜å–
â”‚   â”‚   â””â”€â”€ coordinator.py              # âœ… æ”¯æ´çµ„é•·å­˜å–
â”‚   â”‚
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ base.html                   # âœ… çµ„é•·å°è¦½åˆ—
â”‚       â”œâ”€â”€ home.html                   # âœ… çµ„é•·æŒ‰éˆ•
â”‚       â”‚
â”‚       â”œâ”€â”€ admin/
â”‚       â”‚   â”œâ”€â”€ index.html              # ç®¡ç†å¾Œå°é¦–é 
â”‚       â”‚   â”œâ”€â”€ users.html              # âœ… çµ„é•·é¸é …
â”‚       â”‚   â””â”€â”€ impersonate.html        # âœ… æ¨¡æ“¬çµ„é•·
â”‚       â”‚
â”‚       â”œâ”€â”€ dispatcher/
â”‚       â”‚   â””â”€â”€ dashboard.html          # âœ… å°ˆå“¡/çµ„é•·ç‹€æ…‹
â”‚       â”‚
â”‚       â”œâ”€â”€ coordinator/
â”‚       â”‚   â””â”€â”€ my_patient.html         # å°ˆå“¡é é¢
â”‚       â”‚
â”‚       â””â”€â”€ partials/
â”‚           â”œâ”€â”€ coordinator_stats.html  # âœ… å°ˆå“¡/çµ„é•·çµ±è¨ˆ
â”‚           â”œâ”€â”€ patient_table.html      # ç—…äººåˆ—è¡¨
â”‚           â”œâ”€â”€ station_cards.html      # æª¢æŸ¥ç«™å¡ç‰‡
â”‚           â”œâ”€â”€ station_stats.html      # æª¢æŸ¥ç«™çµ±è¨ˆ
â”‚           â”œâ”€â”€ report_summary.html     # å ±è¡¨æ‘˜è¦
â”‚           â”œâ”€â”€ broken_alert.html       # æ•…éšœè­¦ç¤º
â”‚           â””â”€â”€ notifications.html      # é€šçŸ¥
```

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### å®Œæ•´æ›¿æ›

1. è§£å£“ç¸® `v4-complete.zip`

2. æ›¿æ›ä»¥ä¸‹æª”æ¡ˆ/è³‡æ–™å¤¾ï¼š
   ```
   app/models/user.py
   app/services/auth.py
   app/services/impersonate.py
   app/services/stats.py
   app/routers/admin.py
   app/routers/dispatcher.py
   app/routers/coordinator.py
   app/templates/ (æ•´å€‹è³‡æ–™å¤¾)
   ```

3. æ›´æ–° `app/services/__init__.py`ï¼Œç¢ºä¿æœ‰ï¼š
   ```python
   from . import impersonate
   ```

4. éƒ¨ç½²ï¼š
   ```bash
   git add .
   git commit -m "v4: æ–°å¢çµ„é•·è§’è‰² + ä¿®æ­£æ¨¡æ“¬åŠŸèƒ½"
   git push
   ```

---

## ğŸ‘‘ è§’è‰²æ¬Šé™èªªæ˜

| è§’è‰² | èª¿åº¦å° | å°ˆå“¡é é¢ | ç®¡ç†å¾Œå° |
|------|--------|----------|----------|
| ç®¡ç†å“¡ (admin) | âœ… | âœ… | âœ… |
| çµ„é•· (leader) | âœ… | âœ… | âŒ |
| èª¿åº¦å“¡ (dispatcher) | âœ… | âŒ | âŒ |
| å°ˆå“¡ (coordinator) | âŒ | âœ… | âŒ |
| å¾…å¯©æ ¸ (pending) | âŒ | âŒ | âŒ |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

1. **æ–°ç”¨æˆ¶é è¨­ç‚ºçµ„é•·**ï¼šé€™æ˜¯æ¸¬è©¦éšæ®µè¨­å®šï¼Œä¹‹å¾Œå¯æ”¹å› `pending`
   - ä¿®æ”¹ä½ç½®ï¼š`app/services/auth.py` ç¬¬ 95 è¡Œ
   - æ”¹ç‚ºï¼š`role=UserRole.PENDING.value`

2. **ç¾æœ‰ç”¨æˆ¶ä¸æœƒè‡ªå‹•è®Šæ›´**ï¼šåªæœ‰æ–°è¨»å†Šç”¨æˆ¶æ‰æœƒé è¨­ç‚ºçµ„é•·

3. **è§’è‰²æ¨¡æ“¬ä½¿ç”¨ Cookie**ï¼šä¸éœ€è¦ SessionMiddleware

---

## ğŸ“ ç‰ˆæœ¬æ­·å²

- v1ï¼šåŸå§‹ Phase 9ï¼ˆæœ‰ session å•é¡Œï¼‰
- v2ï¼šä¿®æ­£ session â†’ cookie
- v3ï¼šä¿®æ­£å ±è¡¨æ¬„ä½ + å€‹ç®¡å¸«â†’å°ˆå“¡
- v4ï¼šæ–°å¢çµ„é•·è§’è‰² + ä¿®æ­£æ¨¡æ“¬åŠŸèƒ½
